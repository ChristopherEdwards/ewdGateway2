module.exports = {

  onSocketMessage: function(ewd) {

    var wsMsg = ewd.webSocketMessage;
    var type = wsMsg.type;
    var params = wsMsg.params;
    var sessid = ewd.session.$('ewd_sessid')._value;
    
    if (type === 'EWD.form.login') {
      console.log('login: ' + JSON.stringify(params));
      if (params.username === '') return 'You must enter a username';
      if (params.password === '') return 'You must enter a password';
      var auth = new ewd.mumps.GlobalNode('CLPPassword', [params.username]);
      if (!auth._hasValue) return 'No such user';
      if (auth._value !== params.password) return 'Invalid login attempt';
      ewd.session.setAuthenticated();
      return '';
    }
 
    if (!ewd.session.isAuthenticated) return;    

    if (type === 'getPatientsByPrefix') {
      console.log('getPatientsByPrefix: ' + JSON.stringify(params));
      var matches = [];
      if (params.prefix === '') return matches;
      var index = new ewd.mumps.GlobalNode('CLPPatIndex', ['lastName']);
      index._forPrefix(params.prefix, function(name, subNode) {
        subNode._forEach(function(id, subNode2) {
          matches.push({name: subNode2._value, id: id});
        });
      });
      return matches;
    }
    
    if (type === 'EWD.form.selectPatient') {
      console.log('selectPatient: ' + JSON.stringify(params));
      if (!params.patientId) return 'You must select a patient';
      var patient = new ewd.mumps.GlobalNode('CLPPats', [params.patientId]);
      if (!patient._hasProperties) return 'Invalid selection';
      ewd.sendWebSocketMsg({
        type: 'patientDocument',
        message: patient._getDocument()
      });
      return '';
    }
    
    
  }
};
